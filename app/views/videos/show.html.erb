<h1><%= @video.title %></h1>
<p><%= @video.description %></p>

<!-- 업로드된 동영상 표시 -->
<% if @video.uploaded_video.attached? %>
  <video width="640" height="360" controls>
    <source src="<%= url_for(@video.uploaded_video) %>" type="video/mp4">
    브라우저가 비디오 태그를 지원하지 않습니다.
  </video>
<% elsif @video.video_url.present? %>
  <!-- 유튜브 동영상 표시 -->
  <iframe 
    width="640" 
    height="360" 
    src="https://www.youtube.com/embed/<%= youtube_video_id(@video.video_url) %>" 
    frameborder="0" 
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
    allowfullscreen>
  </iframe>
<% else %>
  <p>동영상이 없습니다.</p>
<% end %>

<!-- 업로드 날짜 -->
<p>업로드 날짜: <%= time_ago_in_words(@video.created_at) %> 전</p>

<!-- 조회수 표시 -->
<p>조회수: <%= @video.views %>회</p>

<!-- 좋아요 / 싫어요 -->
<p>좋아요: <span class="like-count"><%= @video.likes %></span></p>
<p>싫어요: <span class="dislike-count"><%= @video.dislike %></span></p>

<%= button_to '좋아요', like_video_path(@video), method: :patch, class: "like-button", remote: true %>
<%= button_to '싫어요', dislike_video_path(@video), method: :patch, class: "dislike-button", remote: true %>

<%= link_to '목록으로 돌아가기', videos_path %>
<%= link_to '홈으로 돌아가기', root_path %>

<hr>

<!-- 댓글 목록 -->
<h2>댓글</h2>
<% if @comments.any? %>
  <ul class="comments-list">
    <% @comments.each do |comment| %>
      <li class="comment" id="comment_<%= comment.id %>">
        <div class="comment-header">
          <strong><%= comment.user.full_name %></strong>
          <small class="text-muted"><%= time_ago_in_words(comment.created_at) %> 전</small>
        </div>
        <div class="comment-body">
          <p><%= comment.content %></p>
        </div>
        <div class="comment-actions">
          <%= button_to "좋아요 (#{comment.comment_likes_count})", like_video_comment_path(@video, comment), method: :patch, remote: true, class: "btn btn-link btn-sm" %>
          <%= button_to "싫어요 (#{comment.comment_dislikes_count})", dislike_video_comment_path(@video, comment), method: :patch, remote: true, class: "btn btn-link btn-sm" %>

          <!-- 댓글 삭제 링크 -->
          <%= link_to '댓글 삭제', video_comment_path(video_id: @video.id, id: comment.id), method: :delete, remote: true, data: { confirm: '정말 삭제하시겠습니까?' } %>

          <!-- 대댓글 쓰기 버튼 -->
          <%= link_to "대댓글 쓰기", "#", class: "btn btn-link btn-sm reply-button", data: { comment_id: comment.id } %>
        </div>

        <!-- 대댓글 목록 -->
        <% if comment.replies.any? %>
          <ul class="replies-list">
            <% comment.replies.each do |reply| %>
              <li class="reply" id="reply_<%= reply.id %>">
                <div class="reply-header">
                  <strong><%= reply.user.full_name %></strong>
                  <small class="text-muted"><%= time_ago_in_words(reply.created_at) %> 전</small>
                </div>
                <div class="reply-body">
                  <p><%= reply.content %></p>
                </div>
                <div class="reply-actions">
                  <%= button_to "좋아요 (#{reply.comment_likes_count})", like_comment_path(reply), method: :patch, remote: true, class: "btn btn-link btn-sm" %>
                  <%= button_to "싫어요 (#{reply.comment_dislikes_count})", dislike_comment_path(reply), method: :patch, remote: true, class: "btn btn-link btn-sm" %>
                  <%= link_to "삭제", video_comment_path(@video, reply), 
                    method: :delete, remote: true, 
                    class: "btn btn-link btn-sm text-danger", 
                    data: { confirm: "대댓글을 삭제하시겠습니까?" } %>
                </div>
              </li>
            <% end %>
          </ul>
        <% end %>

        <!-- 대댓글 작성 폼 -->
        <div class="reply-form-container" id="reply-form-<%= comment.id %>" style="display: none;">
          <%= form_with(model: [@video, Comment.new], local: false, html: { class: "reply-form" }) do |reply_form| %>
            <div class="field">
              <%= reply_form.text_area :content, placeholder: "대댓글을 입력하세요", rows: 2, class: "form-control" %>
              <%= reply_form.hidden_field :parent_id, value: comment.id %>
            </div>
            <div class="actions">
              <%= reply_form.submit "대댓글 남기기", class: "btn btn-primary btn-sm" %>
            </div>
          <% end %>
        </div>
      </li>
    <% end %>
  </ul>
<% else %>
  <p>댓글이 없습니다. 첫 번째 댓글을 남겨보세요!</p>
<% end %>


<!-- 댓글 작성 폼 -->
<h3>댓글 작성</h3>
<%= form_with(model: [@video, @new_comment], local: false) do |form| %>
  <div class="field">
    <%= form.label :content, "댓글 내용" %>
    <%= form.text_area :content, rows: 3, class: "form-control" %>
  </div>
  <div class="actions">
    <%= form.submit "댓글 남기기", class: "btn btn-primary" %>
  </div>
<% end %>
